<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pronunciation Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f6f8fb;
      margin: 0;
      padding: 16px;
      text-align: center;
    }

    .word {
      font-size: 28px;
      font-weight: 600;
      color: #0b3a82; /* Ê∑±ËìùËâ≤ */
      margin-bottom: 12px;
    }

    button {
      font-size: 16px;
      padding: 10px 18px;
      margin: 6px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    #recordBtn {
      background: #1976d2;
      color: #fff;
    }

    #recordBtn.recording {
      background: #d32f2f;
    }

    #status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    #result {
      margin-top: 12px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <div class="word" id="word">‚Äî</div>

  <button id="recordBtn">ÂºÄÂßãÂΩïÈü≥</button>

  <div id="status"></div>
  <div id="result"></div>

  <script>
    /********************
     * Âèñ Anki ÂçïËØçÂ≠óÊÆµ
     ********************/
    function getWord() {
      // Anki iframe ÈáåÂ∏∏Áî®ÊñπÂºè
      const params = new URLSearchParams(window.location.search);
      return params.get("word") || "‚Äî";
    }

    const WORD = getWord();
    document.getElementById("word").textContent = WORD;

    /********************
     * ÂΩïÈü≥Áõ∏ÂÖ≥ÂèòÈáè
     ********************/
    let audioContext;
    let mediaStream;
    let processor;
    let source;
    let pcmData = [];
    let recording = false;

    const recordBtn = document.getElementById("recordBtn");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");

    /********************
     * PCM ‚Üí WAV (16kHz)
     ********************/
    function pcmToWav(samples, sampleRate = 16000) {
      const buffer = new ArrayBuffer(44 + samples.length * 2);
      const view = new DataView(buffer);

      function writeString(offset, s) {
        for (let i = 0; i < s.length; i++) {
          view.setUint8(offset + i, s.charCodeAt(i));
        }
      }

      writeString(0, "RIFF");
      view.setUint32(4, 36 + samples.length * 2, true);
      writeString(8, "WAVE");
      writeString(12, "fmt ");
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      writeString(36, "data");
      view.setUint32(40, samples.length * 2, true);

      let offset = 44;
      for (let i = 0; i < samples.length; i++, offset += 2) {
        let s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
      }

      return new Blob([view], { type: "audio/wav" });
    }

    /********************
     * ÂºÄÂßãÂΩïÈü≥
     ********************/
    async function startRecording() {
      pcmData = [];
      statusEl.textContent = "üéô Ê≠£Âú®ÂΩïÈü≥‚Ä¶";
      resultEl.textContent = "";

      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          channelCount: 1,
          sampleRate: 16000,
          echoCancellation: false,
          noiseSuppression: false,
          autoGainControl: false
        }
      });

      audioContext = new AudioContext({ sampleRate: 16000 });
      source = audioContext.createMediaStreamSource(mediaStream);
      processor = audioContext.createScriptProcessor(4096, 1, 1);

      processor.onaudioprocess = (e) => {
        pcmData.push(...e.inputBuffer.getChannelData(0));
      };

      source.connect(processor);
      processor.connect(audioContext.destination);

      recording = true;
      recordBtn.textContent = "ÂÅúÊ≠¢ÂΩïÈü≥";
      recordBtn.classList.add("recording");
    }

    /********************
     * ÂÅúÊ≠¢ÂΩïÈü≥Âπ∂ËØÑÊµã
     ********************/
    async function stopRecording() {
      recording = false;
      recordBtn.textContent = "ÂºÄÂßãÂΩïÈü≥";
      recordBtn.classList.remove("recording");
      statusEl.textContent = "‚è≥ Ê≠£Âú®ËØÑÊµã‚Ä¶";

      processor.disconnect();
      source.disconnect();
      mediaStream.getTracks().forEach(t => t.stop());
      await audioContext.close();

      const wav = pcmToWav(pcmData);

      const form = new FormData();
      form.append("audio", wav, "record.wav");
      form.append("word", WORD);

      try {
        const r = await fetch("/assess", {
          method: "POST",
          body: form
        });

        const j = await r.json();

        if (j.error) {
          statusEl.textContent = "‚ùå ËØÑÊµãÂ§±Ë¥•";
          resultEl.textContent = j.error;
          return;
        }

        statusEl.textContent = "‚úÖ ÂÆåÊàê";
        resultEl.textContent = "ÂàÜÊï∞Ôºö" + j.score;

        // üëâ ËøôÈáåÂêéÈù¢Â∞±ÊòØ‰Ω†Áé∞Âú®Âú®ÂÅöÁöÑ„ÄåÈü≥Á¥† UI Ê∏≤Êüì„Äç
        // j.phonemes = [{ ipa, score }]
        // ‰Ω†Â∑≤ÁªèËÉΩÊé•‰∏ä‰∫Ü

      } catch (e) {
        statusEl.textContent = "‚ùå ÁΩëÁªúÊàñÊúçÂä°ÂºÇÂ∏∏";
        resultEl.textContent = "";
      }
    }

    recordBtn.onclick = () => {
      if (!recording) {
        startRecording();
      } else {
        stopRecording();
      }
    };
  </script>

</body>
</html>
