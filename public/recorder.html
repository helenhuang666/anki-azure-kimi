<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Pronunciation</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 10px;
}

#word {
  font-size: 28px;
  text-align: center;
  margin-bottom: 10px;
}

#controls {
  text-align: center;
  margin-bottom: 10px;
}

#status {
  text-align: center;
  margin: 8px 0;
}

#phonemes {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  gap: 6px;
  margin-top: 12px;
}

.phoneme {
  width: 34px;
  border-radius: 4px;
  background: #e5e7eb;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  cursor: pointer;
  padding: 4px 2px;
}

.phoneme-score {
  font-size: 12px;
  font-weight: bold;
}

.phoneme-letters {
  font-size: 12px;
  margin-bottom: 2px;
}

.phoneme-ipa {
  font-size: 14px;
  margin-top: 2px;
}

.phoneme-bar {
  width: 100%;
  background: #60a5fa;
  border-radius: 3px 3px 0 0;
}
</style>
</head>

<body>

<div id="word">{{Word}}</div>

<div id="controls">
  <button id="rec">ğŸ™ å½•éŸ³</button>
  <button id="stop">â¹ åœæ­¢å¹¶è¯„æµ‹</button>
</div>

<div id="status"></div>

<div id="phonemes"></div>

<script>
let audioCtx, processor, input;
let chunks = [];

const recBtn = document.getElementById("rec");
const stopBtn = document.getElementById("stop");
const status = document.getElementById("status");
const phonemeBox = document.getElementById("phonemes");

recBtn.onclick = async () => {
  chunks = [];
  audioCtx = new AudioContext({ sampleRate: 16000 });
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  input = audioCtx.createMediaStreamSource(stream);
  processor = audioCtx.createScriptProcessor(4096, 1, 1);

  processor.onaudioprocess = e => {
    chunks.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };

  input.connect(processor);
  processor.connect(audioCtx.destination);
  status.innerText = "ğŸ™ å½•éŸ³ä¸­...";
};

stopBtn.onclick = async () => {
  processor.disconnect();
  input.disconnect();

  let len = chunks.reduce((a, b) => a + b.length, 0);
  let data = new Float32Array(len);
  let off = 0;
  chunks.forEach(c => {
    data.set(c, off);
    off += c.length;
  });

  // è£æ‰å‰ç½®é™éŸ³
  let start = 0;
  while (start < data.length && Math.abs(data[start]) < 0.02) start++;
  data = data.slice(start);

  const wav = floatToWav(data, 16000);
  const blob = new Blob([wav], { type: "audio/wav" });

  status.innerText = "â³ è¯„æµ‹ä¸­...";
  phonemeBox.innerHTML = "";

  const fd = new FormData();
  fd.append("audio", blob);
  fd.append("word", document.getElementById("word").innerText.trim());

  const r = await fetch("/assess", { method: "POST", body: fd });
  const j = await r.json();

  if (!j.phonemes || j.phonemes.length === 0) {
    status.innerText = "âš ï¸ æœªè¿”å›éŸ³ç´ æ•°æ®";
    return;
  }

  status.innerText = "å‘éŸ³åˆ†æ•°ï¼š" + j.score;
  renderPhonemes(j.phonemes);
};

function renderPhonemes(list) {
  phonemeBox.innerHTML = "";

  list.forEach(p => {
    const h = Math.max(8, p.score); // é˜²æ­¢ 0 çœ‹ä¸è§

    const el = document.createElement("div");
    el.className = "phoneme";

    el.innerHTML = `
      <div class="phoneme-score">${p.score}</div>
      <div class="phoneme-letters">${p.letters || ""}</div>
      <div class="phoneme-bar" style="height:${h}px"></div>
      <div class="phoneme-ipa">${p.ipa}</div>
    `;

    el.onclick = () => {
      const a = new Audio("/audio_phoneme/" + p.ipa + ".mp3");
      a.play();
    };

    phonemeBox.appendChild(el);
  });
}

function floatToWav(float32, sampleRate) {
  const pcm16 = new Int16Array(float32.length);
  for (let i = 0; i < float32.length; i++) {
    pcm16[i] = Math.max(-1, Math.min(1, float32[i])) * 0x7fff;
  }

  const buffer = new ArrayBuffer(44 + pcm16.length * 2);
  const view = new DataView(buffer);

  write(view, 0, "RIFF");
  view.setUint32(4, 36 + pcm16.length * 2, true);
  write(view, 8, "WAVE");
  write(view, 12, "fmt ");
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  write(view, 36, "data");
  view.setUint32(40, pcm16.length * 2, true);

  let p = 44;
  pcm16.forEach(s => {
    view.setInt16(p, s, true);
    p += 2;
  });

  return buffer;
}

function write(v, o, s) {
  for (let i = 0; i < s.length; i++) {
    v.setUint8(o + i, s.charCodeAt(i));
  }
}
</script>

</body>
</html>
